<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>句動詞学習サイト DEMO v4</title>
    <style>
        /* (CSSはv3から変更ありませんが、念のためすべて含めています) */
        :root {
            --base-bg: #F8F9FA; --main-blue: #007BFF; --accent-orange: #FD7E14;
            --text-dark: #212529; --text-medium: #6C757D; --border-light: #CED4DA;
            --success-green: #28a745; --danger-red: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; margin: 0; background-color: var(--base-bg); color: var(--text-dark); line-height: 1.7; font-size: 16px; }
        .header { background-color: var(--main-blue); color: white; padding: 15px 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { margin: 0; font-size: 20px; }
        .container { padding: 20px; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 15px; font-size: 16px; border: 1px solid var(--border-light); border-radius: 8px; box-sizing: border-box; }
        #search-results { list-style-type: none; padding: 0; margin: 20px 0 0; }
        #search-results li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; background-color: white; }
        #search-results li:hover { background-color: #f0f0f0; }
        #search-results li .meaning { font-size: 14px; color: var(--text-medium); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .page { display: none; background-color: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #detail-page h2 { font-size: 28px; margin-top: 0; }
        .back-button { display: inline-block; margin-bottom: 20px; color: var(--main-blue); cursor: pointer; font-weight: bold; }
        .meaning-block { border-top: 1px solid #eee; padding: 20px 0; }
        .meaning-block h3 { font-size: 20px; margin-top: 0; margin-bottom: 10px; }
        .meaning-block .pos { font-size: 14px; color: var(--text-medium); font-style: italic; }
        .example-sentence { background-color: var(--base-bg); padding: 12px; border-radius: 4px; margin: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .example-sentence p { margin: 0; }
        .my-example-area { margin-top: 15px; }
        .add-my-example-btn { background: none; border: 1px dashed var(--accent-orange); color: var(--accent-orange); padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .my-example-input-area { margin-top: 10px; display: none; }
        .my-example-input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid var(--border-light); border-radius: 4px; min-height: 80px; }
        .action-buttons { text-align: right; margin-top: 5px; }
        .action-buttons button { border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        .save-btn { background-color: var(--accent-orange); color: white; }
        .cancel-btn { background-color: var(--text-medium); color: white; margin-left: 5px; }
        .example-controls button { background: none; border: none; cursor: pointer; font-size: 12px; margin-left: 8px; }
        .edit-btn { color: var(--main-blue); }
        .delete-btn { color: var(--danger-red); }
        .filter-section { margin-bottom: 20px; padding: 15px; background-color: #fff; border-radius: 8px; }
        .filter-section h3 { font-size: 16px; color: var(--text-medium); margin-top: 0; margin-bottom: 10px; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-btn { background-color: white; border: 1px solid var(--border-light); color: var(--main-blue); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .filter-btn.active { background-color: var(--main-blue); color: white; border-color: var(--main-blue); }
        .data-management-section { background-color: white; padding: 20px; margin-top: 30px; border-radius: 8px; }
        .toggle-btn { background-color: var(--success-green); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-bottom: 10px; }
        #bulk-add-area, #manual-add-area { margin-top: 15px; border-top: 1px solid var(--border-light); padding-top: 15px; }
        #bulk-add-input, .manual-input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--border-light); border-radius: 4px; margin-bottom: 10px; }
        #bulk-add-input { min-height: 150px; font-family: monospace; }
        .submit-btn { background-color: var(--accent-orange); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .manual-add-meaning-block { background-color: var(--base-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <header class="header"><h1>句動詞学習サイト DEMO v4</h1></header>
    <div class="container">
        <div id="home-page">
            <div class="search-box">
                <input type="text" id="search-input" class="search-input" placeholder="句動詞、意味などで検索...">
            </div>
            <div class="filter-section">
                <h3>動詞で探す</h3>
                <div id="verb-filters" class="filter-buttons"></div>
                <h3 style="margin-top: 20px;">前置詞/副詞で探す</h3>
                <div id="particle-filters" class="filter-buttons"></div>
            </div>
            <ul id="search-results"></ul>

            <div class="data-management-section">
                <button id="show-manual-add-btn" class="toggle-btn">✍️ 新しい句動詞を手動で追加</button>
                <div id="manual-add-area" style="display: none;">
                    <input type="text" id="manual-id" class="manual-input" placeholder="句動詞ID (例: 7, 8...) ※他の単語と違う数字">
                    <input type="text" id="manual-phrase" class="manual-input" placeholder="句動詞 (例: get up)">
                    <div id="manual-meanings-container">
                        </div>
                    <button id="add-meaning-field-btn" style="margin-bottom: 15px;">+ 意味を追加</button>
                    <button id="manual-add-submit-btn" class="submit-btn">この句動詞を保存</button>
                </div>

                <button id="show-bulk-add-btn" class="toggle-btn">⚙️ 句動詞データの一括追加</button>
                <div id="bulk-add-area" style="display: none;">
                    <p style="font-size:14px; color: var(--text-medium);">以下の形式でデータを貼り付けてください。</p>
                    <textarea id="bulk-add-input" placeholder='[{"id": 8, "phrase": "new verb", "meanings": [{"id": 801, "meaning": "...", "pos": "...", "example": "..."}]}]'></textarea>
                    <button id="bulk-add-submit-btn" class="submit-btn">この内容でデータを追加する</button>
                </div>
            </div>
        </div>
        <div id="detail-page" class="page"></div>
    </div>

    <script>
        // =================================================================
        // --- 1. データベース設定 ---
        // =================================================================
        let phrasalVerbsDB = [];
        let myExamples = JSON.parse(localStorage.getItem('myPhrasalVerbExamples')) || {};
        const initialDB = [
            { id: 1, phrase: "take off", meanings: [{ id: 101, meaning: "離陸する", pos: "自動詞", example: "The plane took off on time." },{ id: 102, meaning: "〜を脱ぐ", pos: "他動詞", example: "Please take off your shoes." },{ id: 103, meaning: "(人気・売上が)急増する", pos: "自動詞", example: "Her career took off after that movie." }] },
            { id: 2, phrase: "put off", meanings: [{ id: 201, meaning: "〜を延期する", pos: "他動詞", example: "We had to put off the meeting." },{ id: 202, meaning: "（人）の気をそぐ", pos: "他動詞", example: "The bad smell put me off my food." }] },
            { id: 3, phrase: "get over", meanings: [{ id: 301, meaning: "〜を克服する、乗り越える", pos: "他動詞", example: "He finally got over his illness." },{ id: 302, meaning: "〜に驚く", pos: "他動詞", example: "I can't get over how much she has grown." }] },
            { id: 4, phrase: "look forward to", meanings: [{ id: 401, meaning: "〜を楽しみに待つ", pos: "他動詞", example: "I'm looking forward to seeing you again." }] },
            { id: 5, phrase: "carry out", meanings: [{ id: 501, meaning: "〜を実行する、実施する", pos: "他動詞", example: "The team carried out the plan perfectly." }] },
            { id: 6, phrase: "get on", meanings: [{id: 601, meaning: "〜に乗る", pos:"他動詞", example: "I get on the train at 8 am."}, {id: 602, meaning: "仲良くやる", pos:"自動詞", example: "I get on well with my colleagues."}] }
        ];

        // --- 2. DOM要素の取得 ---
        const searchInput = document.getElementById('search-input'), searchResults = document.getElementById('search-results');
        const homePage = document.getElementById('home-page'), detailPage = document.getElementById('detail-page');
        const showBulkAddBtn = document.getElementById('show-bulk-add-btn'), bulkAddArea = document.getElementById('bulk-add-area'), bulkAddInput = document.getElementById('bulk-add-input'), bulkAddSubmitBtn = document.getElementById('bulk-add-submit-btn');
        const showManualAddBtn = document.getElementById('show-manual-add-btn'), manualAddArea = document.getElementById('manual-add-area'), manualAddSubmitBtn = document.getElementById('manual-add-submit-btn'), addMeaningFieldBtn = document.getElementById('add-meaning-field-btn');

        // =================================================================
        // --- アプリケーションの初期化 ---
        // =================================================================
        function initializeApp() {
            const savedDB = localStorage.getItem('phrasalVerbsDB');
            phrasalVerbsDB = savedDB ? JSON.parse(savedDB) : initialDB;
            generateFilterButtons();
            setupEventListeners();
            addMeaningField(); // 最初に1つの意味入力欄を追加
        }

        // --- 3. イベントリスナーの設定 ---
        function setupEventListeners() {
            searchInput.addEventListener('input', handleSearch);
            showBulkAddBtn.addEventListener('click', () => toggleArea(bulkAddArea));
            bulkAddSubmitBtn.addEventListener('click', handleBulkAdd);
            showManualAddBtn.addEventListener('click', () => toggleArea(manualAddArea));
            addMeaningFieldBtn.addEventListener('click', addMeaningField);
            manualAddSubmitBtn.addEventListener('click', handleManualAdd);
        }

        function toggleArea(area) {
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        // =================================================================
        // --- 5. 機能の定義 ---
        // =================================================================

        // --- 手動追加機能 ---
        let meaningFieldCount = 0;
        function addMeaningField() {
            meaningFieldCount++;
            const container = document.getElementById('manual-meanings-container');
            const newField = document.createElement('div');
            newField.className = 'manual-add-meaning-block';
            newField.innerHTML = `
                <strong>意味 #${meaningFieldCount}</strong>
                <input type="text" class="manual-input manual-meaning-id" placeholder="意味ID (例: 701, 702...) ※他の意味と違う数字">
                <input type="text" class="manual-input manual-meaning" placeholder="意味 (例: 〜を調べる)">
                <input type="text" class="manual-input manual-pos" placeholder="品詞 (例: 他動詞)">
                <input type="text" class="manual-input manual-example" placeholder="公式例文">
            `;
            container.appendChild(newField);
        }

        function handleManualAdd() {
            try {
                const verbId = parseInt(document.getElementById('manual-id').value);
                const phrase = document.getElementById('manual-phrase').value.trim();
                if (!verbId || !phrase) throw new Error("句動詞IDと句動詞は必須です。");
                if (phrasalVerbsDB.some(v => v.id === verbId)) throw new Error(`句動詞ID ${verbId} は既に使用されています。`);

                const meanings = [];
                const meaningBlocks = document.querySelectorAll('.manual-add-meaning-block');
                meaningBlocks.forEach(block => {
                    const meaningId = parseInt(block.querySelector('.manual-meaning-id').value);
                    const meaning = block.querySelector('.manual-meaning').value.trim();
                    if (meaningId && meaning) {
                        meanings.push({
                            id: meaningId,
                            meaning: meaning,
                            pos: block.querySelector('.manual-pos').value.trim(),
                            example: block.querySelector('.manual-example').value.trim()
                        });
                    }
                });

                if (meanings.length === 0) throw new Error("少なくとも1つの有効な意味を入力してください。");
                
                phrasalVerbsDB.push({ id: verbId, phrase, meanings });
                updateDatabaseAndUI();
                alert(`「${phrase}」が正常に追加されました。`);
                // フォームをリセット
                manualAddArea.style.display = 'none';
                document.getElementById('manual-id').value = '';
                document.getElementById('manual-phrase').value = '';
                document.getElementById('manual-meanings-container').innerHTML = '';
                meaningFieldCount = 0;
                addMeaningField();
            } catch (e) {
                alert("エラー: " + e.message);
            }
        }
        
        // --- データ一括追加機能 ---
        function handleBulkAdd() {
            try {
                const newData = JSON.parse(bulkAddInput.value);
                if (!Array.isArray(newData)) throw new Error("データは配列[...]形式である必要があります。");
                let addedCount = 0;
                newData.forEach(newItem => {
                    if (newItem.id && newItem.phrase && newItem.meanings && !phrasalVerbsDB.some(item => item.id === newItem.id)) {
                        phrasalVerbsDB.push(newItem);
                        addedCount++;
                    }
                });
                if (addedCount > 0) {
                    updateDatabaseAndUI();
                    alert(`${addedCount}件の新しい句動詞が正常に追加されました。`);
                    bulkAddInput.value = '';
                    bulkAddArea.style.display = 'none';
                } else {
                    alert("追加できる新しいデータがありませんでした。ID重複またはデータ形式が不適切です。");
                }
            } catch (e) {
                alert("データの形式が正しくありません。\nエラー: " + e.message);
            }
        }

        function updateDatabaseAndUI() {
            localStorage.setItem('phrasalVerbsDB', JSON.stringify(phrasalVerbsDB));
            generateFilterButtons(); // 絞り込みボタンを更新
        }
        
        // --- 絞り込み・検索・表示機能 (v3から変更なし) ---
        function generateFilterButtons() { /* ... */ }
        function filterBy(type, keyword) { /* ... */ }
        function displayResults(verbList) { /* ... */ }
        function handleSearch(event) { /* ... */ }
        function showHomePage() { /* ... */ }
        function showDetailPage(verbId) { /* ... */ }
        // --- マイ例文 CRUD 機能 (v3から変更なし) ---
        function saveMyExample(meaningId, editingIndex = null) { /* ... */ }
        function renderMyExamples(meaningId) { /* ... */ }
        function editMyExample(meaningId, index) { /* ... */ }
        function deleteMyExample(meaningId, index) { /* ... */ }
        function showInputArea(meaningId) { /* ... */ }
        function hideInputArea(meaningId) { /* ... */ }

        // --- 関数の詳細な実装 (v3から変更がない部分は省略しています) ---
        function generateFilterButtons() { const vF=document.getElementById('verb-filters'),pF=document.getElementById('particle-filters');vF.innerHTML='';pF.innerHTML='';const vs=[...new Set(phrasalVerbsDB.map(p=>p.phrase.split(' ')[0]))].sort(),ps=[...new Set(phrasalVerbsDB.flatMap(p=>p.phrase.split(' ').slice(1)))].sort();vs.forEach(v=>{const b=document.createElement('button');b.className='filter-btn';b.textContent=v;b.dataset.verb=v;b.onclick=()=>filterBy('verb',v);vF.appendChild(b)});ps.forEach(p=>{if(!p)return;const b=document.createElement('button');b.className='filter-btn';b.textContent=p;b.dataset.particle=p;b.onclick=()=>filterBy('particle',p);pF.appendChild(b)})}
        function filterBy(t, k){let fv;if(t==='verb'){fv=phrasalVerbsDB.filter(p=>p.phrase.split(' ')[0]===k)}else{fv=phrasalVerbsDB.filter(p=>p.phrase.split(' ').slice(1).includes(k))}displayResults(fv);document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));document.querySelector(`.filter-btn[data-${t}='${k}']`).classList.add('active')}
        function displayResults(vl){searchResults.innerHTML='';if(vl.length===0){searchResults.innerHTML='<li>該当なし</li>';return}vl.forEach(p=>{const li=document.createElement('li');li.innerHTML=`<div class="phrase">${p.phrase}</div><div class="meaning">${p.meanings.map(m=>m.meaning).join('、')}</div>`;li.onclick=()=>showDetailPage(p.id);searchResults.appendChild(li)})}
        function handleSearch(e){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));const q=e.target.value.toLowerCase();if(!q){searchResults.innerHTML='';return}const f=phrasalVerbsDB.filter(p=>p.phrase.toLowerCase().includes(q)||p.meanings.some(m=>m.meaning.includes(q)));displayResults(f)}
        function showHomePage(){detailPage.style.display='none';homePage.style.display='block';searchInput.value='';searchResults.innerHTML='';document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));searchInput.focus()}
        function showDetailPage(vId){const v=phrasalVerbsDB.find(p=>p.id===vId);if(!v)return;const mH=v.meanings.map(m=>`<div class="meaning-block" data-meaning-id="${m.id}"><h3>${m.meaning} <span class="pos">${m.pos}</span></h3><div class="example-sentence"><p><strong>公式例文:</strong> ${m.example}</p></div><div class="my-example-area"><div id="my-example-list-${m.id}"></div><button class="add-my-example-btn" onclick="showInputArea(${m.id})">⊕ この意味でマイ例文を追加</button><div class="my-example-input-area" id="input-area-${m.id}"><textarea class="my-example-input" placeholder="..."></textarea><div class="action-buttons"><button class="save-btn" onclick="saveMyExample(${m.id})">保存</button><button class="cancel-btn" onclick="hideInputArea(${m.id})">キャンセル</button></div></div></div></div>`).join('');detailPage.innerHTML=`<div class="back-button" onclick="showHomePage()">＜ 検索/一覧に戻る</div><h2>${v.phrase}</h2>${mH}`;v.meanings.forEach(m=>renderMyExamples(m.id));homePage.style.display='none';detailPage.style.display='block'}
        function saveMyExample(mId,eIdx=null){const iE=eIdx!==null,iAId=iE?`edit-area-${mId}-${eIdx}`:`input-area-${mId}`,iA=document.getElementById(iAId),ta=iA.querySelector('textarea'),s=ta.value.trim();if(s){if(!myExamples[mId])myExamples[mId]=[];if(iE){myExamples[mId][eIdx]=s}else{myExamples[mId].push(s)}localStorage.setItem('myPhrasalVerbExamples',JSON.stringify(myExamples));if(!iE){ta.value='';hideInputArea(mId)}renderMyExamples(mId)}}
        function renderMyExamples(mId){const lC=document.getElementById(`my-example-list-${mId}`);if(!lC)return;const exs=myExamples[mId]||[];lC.innerHTML=exs.map((ex,idx)=>`<div class="example-sentence" id="my-example-${mId}-${idx}"><p><strong>マイ例文:</strong> ${ex.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p><div class="example-controls"><button class="edit-btn" onclick="editMyExample(${mId},${idx})">編集</button><button class="delete-btn" onclick="deleteMyExample(${mId},${idx})">削除</button></div></div><div class="my-example-input-area" id="edit-area-${mId}-${idx}"></div>`).join('')}
        function editMyExample(mId,idx){const eTxt=myExamples[mId][idx],eA=document.getElementById(`edit-area-${mId}-${idx}`),eD=document.getElementById(`my-example-${mId}-${idx}`);eD.style.display='none';eA.style.display='block';eA.innerHTML=`<textarea class="my-example-input">${eTxt}</textarea><div class="action-buttons"><button class="save-btn" onclick="saveMyExample(${mId},${idx})">変更を保存</button><button class="cancel-btn" onclick="renderMyExamples(${mId})">キャンセル</button></div>`}
        function deleteMyExample(mId,idx){if(confirm("この例文を本当に削除しますか？")){myExamples[mId].splice(idx,1);localStorage.setItem('myPhrasalVerbExamples',JSON.stringify(myExamples));renderMyExamples(mId)}}
        function showInputArea(mId){document.getElementById(`input-area-${mId}`).style.display='block'}
        function hideInputArea(mId){document.getElementById(`input-area-${mId}`).style.display='none'}

        // --- アプリケーションの実行開始 ---
        initializeApp();
    </script>
</body>
</html>
